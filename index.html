<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel to SQL Converter</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.20.0/babel.min.js"></script>
    <style>
        /* Custom styling */
        .drag-indicator {
            background-color: rgba(99, 102, 241, 0.2);
            border: 1px dashed #6366f1;
        }
        
        .shimmer {
            animation: shimmer 2s infinite linear;
            background: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%);
            background-size: 800px 104px;
        }
        
        @keyframes shimmer {
            0% {
                background-position: -468px 0;
            }
            100% {
                background-position: 468px 0;
            }
        }
        
        .btn-primary {
            @apply px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md shadow-sm transition duration-150;
        }
        
        .btn-secondary {
            @apply px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-md shadow-sm transition duration-150 border border-gray-300;
        }
        
        .btn-danger {
            @apply px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md shadow-sm transition duration-150;
        }
        
        .logo-gradient {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Smooth scrolling for the entire page */
        html {
            scroll-behavior: smooth;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c5c7d3;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8aab8;
        }
        
        /* For tooltips */
        .tooltip {
            position: relative;
        }
        
        .tooltip:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app"></div>
    
    <script type="text/babel">
        // Main application component
        const App = () => {
            const [excelFile, setExcelFile] = React.useState(null);
            const [fileName, setFileName] = React.useState('');
            const [sheetsData, setSheetsData] = React.useState({});
            const [templates, setTemplates] = React.useState({});
            const [selectedSheetName, setSelectedSheetName] = React.useState(null);
            const [currentView, setCurrentView] = React.useState('main'); // main, configureSheet, manageTemplates
            const [isLoading, setIsLoading] = React.useState(false);
            const [sqlPreview, setSqlPreview] = React.useState('');
            
            // Load templates from localStorage on component mount
            React.useEffect(() => {
                const savedTemplates = localStorage.getItem('excelToSqlTemplates');
                if (savedTemplates) {
                    try {
                        setTemplates(JSON.parse(savedTemplates));
                    } catch (e) {
                        console.error("Error loading templates:", e);
                    }
                }
            }, []);
            
            // Save templates to localStorage when templates change
            React.useEffect(() => {
                if (Object.keys(templates).length > 0) {
                    localStorage.setItem('excelToSqlTemplates', JSON.stringify(templates));
                }
            }, [templates]);
            
            const importExcel = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                setIsLoading(true);
                setFileName(file.name);
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                        
                        const tempSheetsData = {};
                        
                        // ฟังก์ชันแปลง Index เป็นชื่อคอลัมน์ เช่น 0 → A, 1 → B, 26 → AA
                        const getColumnName = (index) => {
                            let columnName = '';
                            while (index >= 0) {
                                columnName = String.fromCharCode((index % 26) + 65) + columnName;
                                index = Math.floor(index / 26) - 1;
                            }
                            return columnName;
                        };

                        // Process each sheet
                        workbook.SheetNames.forEach(sheetName => {
                            const worksheet = workbook.Sheets[sheetName];
                            const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            // ดึงช่วงคอลัมน์จาก !ref เช่น A1:D10
                            const range = XLSX.utils.decode_range(worksheet['!ref']);
                            const startCol = range.s.c; // เริ่มที่คอลัมน์ไหน (Index)
                            const endCol = range.e.c;   // สิ้นสุดที่คอลัมน์ไหน (Index)

                            // สร้าง columnNames ที่มีชื่อคอลัมน์จริง เช่น A, B, C
                            const columnNames = [];
                            for (let i = startCol; i <= endCol; i++) {
                                columnNames.push(getColumnName(i));
                            }

                            // Default header row is 0 (first row) in the array
                            const headerRow = 0;
                            const headers = json[headerRow];
                            const rows = json.slice(headerRow + 1);
                            
                            tempSheetsData[sheetName] = {
                                columnNames: columnNames, // เก็บ A, B, C ไว้ต่างหาก
                                headers: headers,         // เก็บชื่อจริงเช่น Name, Age
                                data: rows,
                                rowCount: rows.length,
                                tableName: '',
                                columnTypes: {},
                                selectedColumns: [],
                                headerRow: headerRow + 1, // Convert to 1-based for UI
                            };
                        });
                        
                        setSheetsData(tempSheetsData);
                        setExcelFile(file);
                        setIsLoading(false);
                    } catch (error) {
                        console.error("Error parsing Excel file:", error);
                        setIsLoading(false);
                        alert("Failed to parse Excel file. Please check the file format.");
                    }
                };
                
                reader.onerror = () => {
                    setIsLoading(false);
                    alert("Error reading file");
                };
                
                reader.readAsArrayBuffer(file);
            };

            const configureSheet = (sheetName) => {
                setSelectedSheetName(sheetName);
                setCurrentView('configureSheet');
            };
            
            const deleteSheet = (sheetName) => {
                if (window.confirm(`Are you sure you want to delete sheet "${sheetName}"?`)) {
                    const updatedSheetsData = {...sheetsData};
                    delete updatedSheetsData[sheetName];
                    setSheetsData(updatedSheetsData);
                }
            };
            
            const changeHeaderRow = (sheetName, newHeaderRow, preserveColumns = false, columnsToPreserve = null, typesToPreserve = null) => {
                setIsLoading(true);
                
                // Re-read the Excel file with the new header row
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                        
                        const worksheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        // Convert to 0-based index for processing
                        const headerRowIndex = newHeaderRow - 1;
                        const headers = json[headerRowIndex];
                        const rows = json.slice(headerRowIndex + 1);
                        
                        // Determine whether to keep or reset columns
                        let selectedColumns = [];
                        let columnTypes = {}; // Initialize as empty object, not undefined
                        
                        if (preserveColumns && columnsToPreserve && typesToPreserve) {
                            // Check if preserved columns still exist in the new headers
                            selectedColumns = columnsToPreserve.filter(col => headers.includes(col));
                            
                            // Only keep types for columns that still exist
                            if (typesToPreserve && typeof typesToPreserve === 'object') {
                                Object.keys(typesToPreserve).forEach(col => {
                                    if (headers.includes(col)) {
                                        columnTypes[col] = typesToPreserve[col];
                                    }
                                });
                            }
                        }
                        
                        // Create updated sheet data
                        const updatedSheetsData = {
                            ...sheetsData,
                            [sheetName]: {
                                ...sheetsData[sheetName],
                                headers: headers,
                                data: rows,
                                rowCount: rows.length,
                                headerRow: newHeaderRow,
                                selectedColumns: selectedColumns,
                                columnTypes: columnTypes, // Ensure this is always an object
                            }
                        };
                        
                        setSheetsData(updatedSheetsData);
                        setIsLoading(false);
                    } catch (error) {
                        console.error("Error reparsing Excel file:", error);
                        setIsLoading(false);
                        alert("Failed to change header row. Please check the file format.");
                    }
                };
                
                reader.readAsArrayBuffer(excelFile);
            };

            const generateSqlStatements = (sheetName, rowLimit = null) => {
                const sheetData = sheetsData[sheetName];
                const tableName = sheetData.tableName;
                
                if (!tableName) return [];
                
                const data = sheetData.data;
                const selectedColumns = sheetData.selectedColumns;
                const columnTypes = sheetData.columnTypes || {}; // ให้แน่ใจว่าเป็น object เสมอ
                
                if (!selectedColumns.length) return [];
                
                const sqlStatements = [];
                
                // Process each row, with optional limit
                const maxRows = rowLimit ? Math.min(rowLimit, data.length) : data.length;
                
                for (let rowIdx = 0; rowIdx < maxRows; rowIdx++) {
                    const row = data[rowIdx];
                    const values = [];
                    
                    for (let colIdx = 0; colIdx < selectedColumns.length; colIdx++) {
                        const column = selectedColumns[colIdx];
                        const headerIndex = sheetData.headers.indexOf(column);
                        
                        if (headerIndex === -1) {
                            values.push("NULL");
                            continue;
                        }
                        
                        const cellValue = row[headerIndex];
                        
                        // เปลี่ยนเงื่อนไขให้ค่าเริ่มต้นเป็น text ยกเว้นเมื่อระบุเป็น int
                        if (cellValue === undefined || cellValue === null) {
                            values.push("NULL");
                        } else if (columnTypes[column]?.toLowerCase() !== "int") { // ค่าเริ่มต้นเป็น text
                            // Escape single quotes for SQL
                            const strValue = String(cellValue).replace(/'/g, "''");
                            values.push(`LTRIM(RTRIM(N'${strValue}'))`);
                        } else { // int type
                            try {
                                // Try to convert to integer
                                const intValue = parseInt(cellValue);
                                if (isNaN(intValue)) {
                                    values.push("NULL");
                                } else {
                                    values.push(intValue.toString());
                                }
                            } catch (e) {
                                values.push("NULL");
                            }
                        }
                    }
                    
                    // Create INSERT statement
                    const sql = `INSERT INTO ${tableName} VALUES(${values.join(',')});`;
                    sqlStatements.push(sql);
                }
                
                return sqlStatements;
            };
            
            const previewSql = (sheetName) => {
                const sheetData = sheetsData[sheetName];
                
                // Generate all SQL statements (no row limit)
                const sqlStatements = generateSqlStatements(sheetName); 
                if (sqlStatements.length === 0) {
                    alert("No SQL statements generated. Please configure the sheet first.");
                    return;
                }
                
                setSqlPreview(sqlStatements.join('\n'));
                
                // Open the SQL preview modal
                document.getElementById('sqlPreviewModal').classList.remove('hidden');
            };
            
            const downloadSql = (sheetName) => {
                const sqlStatements = generateSqlStatements(sheetName);
                if (sqlStatements.length === 0) {
                    alert("No SQL statements generated. Please configure the sheet first.");
                    return;
                }
                
                const sqlContent = sqlStatements.join('\n');
                const blob = new Blob([sqlContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${sheetName}.sql`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
            
            const generateExcelFormula = (sheetName) => {
                const sheetData = sheetsData[sheetName];

                const tableName = sheetData.tableName;
                if (!tableName) {
                    alert("Table name not configured");
                    return;
                }
                
                const selectedColumns = sheetData.selectedColumns;
                if (!selectedColumns.length) {
                    alert("No columns selected");
                    return;
                }
                
                // Get column references and types
                const formulaParts = [];
                const headers = sheetData.headers;
                
                // Calculate the data starting row (headerRow + 1)
                const dataRow = sheetData.headerRow + 1;
                
                for (let i = 0; i < selectedColumns.length; i++) {
                    const col = selectedColumns[i];
                    const colIdx = headers.indexOf(col);
                    const colLetter = sheetData.columnNames[colIdx]; // ใช้ columnNames แทน String.fromCharCode()

                    if (sheetData.columnTypes[col]?.toLowerCase() === "text") {
                        // ใช้ LTRIM RTRIM สำหรับ Text โดยให้ & อยู่ข้างนอกเสมอ
                        formulaParts.push(`LTRIM(RTRIM(N'"&${colLetter}${dataRow}&"'))`);
                    } else {
                        // สำหรับ Number ก็ใช้ & ข้างนอกเช่นกัน เพื่อให้ Excel อ่านเป็นสูตร
                        formulaParts.push(`"&${colLetter}${dataRow}&"`);
                    }
                }
                
                // เชื่อม formulaParts ด้วย & อย่างถูกต้อง โดยไม่มี " ตรงกลาง
                const joinedParts = formulaParts.join(',');
                const excelFormula = `="INSERT INTO ${tableName} VALUES(${joinedParts})"`;
                
                // Display formula in modal
                document.getElementById('formulaText').textContent = excelFormula;
                document.getElementById('formulaModal').classList.remove('hidden');
            };

            const saveTemplate = (sheetName, templateName) => {
                const sheetData = sheetsData[sheetName];
                
                if (!templateName) {
                    // Generate a default name if none provided
                    const date = new Date().toISOString().slice(0, 16).replace('T', ' ');
                    templateName = `${fileName} - ${sheetName} - ${date}`;
                }
                
                // Create template data
                const templateData = {
                    [sheetName]: {
                        tableName: sheetData.tableName,
                        columnTypes: sheetData.columnTypes,
                        selectedColumns: sheetData.selectedColumns,
                        fileName: fileName,
                        headerRow: sheetData.headerRow,
                        timestamp: new Date().toISOString()
                    }
                };
                
                // Save template
                setTemplates({
                    ...templates,
                    [templateName]: templateData
                });
                
                alert(`Template "${templateName}" saved successfully`);
            };

            const updateTableName = (sheetName, newTableName) => {
                setSheetsData(prevData => ({
                    ...prevData,
                    [sheetName]: {
                        ...prevData[sheetName],
                        tableName: newTableName
                    }
                }));
            };

            const loadTemplate = (templateName, templateSheetName) => {
                if (!templates[templateName] || !templates[templateName][templateSheetName]) {
                    alert("Template not found");
                    return;
                }

                // ดึงข้อมูลเทมเพลต
                const templateData = templates[templateName][templateSheetName];

                // ให้ใช้ชีตปัจจุบันที่กำลังทำงานอยู่ (selectedSheetName) แทนที่จะใช้ชื่อชีตจากเทมเพลต
                const currentSheetName = selectedSheetName;
                
                // ตรวจสอบว่า currentSheetName มีอยู่จริง
                if (!sheetsData[currentSheetName]) {
                    alert(`Current sheet not found. Please try again.`);
                    return;
                }

                // Get template values with robust default handling
                const templateTableName = templateData.tableName || `${currentSheetName}_table`;
                const templateColumnTypes = { ...templateData.columnTypes } || {};
                const templateSelectedColumns = [...(templateData.selectedColumns || [])];
                const templateHeaderRow = templateData.headerRow || 1;

                // อ่าน Excel file โดยตรงเพื่อให้ได้ headers ที่ถูกต้อง
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                        
                        // ใช้ชีตปัจจุบันแทนชีตในเทมเพลต
                        const worksheet = workbook.Sheets[currentSheetName];
                        if (!worksheet) {
                            alert(`Sheet "${currentSheetName}" not found in current file.`);
                            return;
                        }
                        
                        const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        // ใช้ templateHeaderRow (0-based index) เพื่อดึง headers ที่ถูกต้อง
                        const headerRowIndex = templateHeaderRow - 1; // แปลงเป็น 0-based index
                        if (headerRowIndex < 0 || headerRowIndex >= json.length) {
                            alert(`Header row ${templateHeaderRow} is out of range for this sheet.`);
                            return;
                        }
                        
                        const currentHeaders = json[headerRowIndex] || [];
                        
                        // ตรวจสอบว่าคอลัมน์ที่เลือกในเทมเพลตมีอยู่ในชีตปัจจุบันหรือไม่
                        const missingColumns = templateSelectedColumns.filter(col => !currentHeaders.includes(col));
                        
                        // ทำการเปลี่ยน headerRow และใช้เทมเพลต
                        if (templateHeaderRow !== sheetsData[currentSheetName].headerRow) {
                            // หากมีคอลัมน์ที่ไม่พบ แจ้งเตือนผู้ใช้
                            if (missingColumns.length > 0) {
                                alert(`Warning: The following columns from the template were not found in the current sheet (with header row ${templateHeaderRow}):\n\n${missingColumns.join(", ")}\n\nThe template will be applied with only the matching columns.`);
                                
                                // กรองเฉพาะคอลัมน์ที่มีอยู่จริง
                                const validColumns = templateSelectedColumns.filter(col => currentHeaders.includes(col));
                                const validColumnTypes = {};
                                
                                // กรองประเภทคอลัมน์เฉพาะที่มีอยู่จริง
                                validColumns.forEach(col => {
                                    if (templateColumnTypes[col]) {
                                        validColumnTypes[col] = templateColumnTypes[col];
                                    }
                                });
                                
                                // เปลี่ยน headerRow พร้อมกับเก็บคอลัมน์ที่ถูกต้อง
                                changeHeaderRow(
                                    currentSheetName, 
                                    templateHeaderRow, 
                                    true,  // เก็บคอลัมน์ที่มีอยู่จริง
                                    validColumns,
                                    validColumnTypes
                                );
                            } else {
                                // ทุกคอลัมน์มีอยู่จริง เปลี่ยน headerRow พร้อมเก็บข้อมูลทั้งหมด
                                changeHeaderRow(
                                    currentSheetName, 
                                    templateHeaderRow, 
                                    true,  // เก็บคอลัมน์ทั้งหมด
                                    templateSelectedColumns,
                                    templateColumnTypes
                                );
                            }
                            
                            // หลังจากเปลี่ยน headerRow แล้ว อัปเดต tableName
                            setTimeout(() => {
                                setSheetsData(prevData => ({
                                    ...prevData,
                                    [currentSheetName]: {
                                        ...prevData[currentSheetName],
                                        tableName: templateTableName
                                    }
                                }));
                            }, 200);
                        } else {
                            // headerRow เท่ากันอยู่แล้ว แค่ตรวจสอบคอลัมน์
                            if (missingColumns.length > 0) {
                                alert(`Warning: The following columns from the template were not found in the current sheet:\n\n${missingColumns.join(", ")}\n\nThe template will be applied with only the matching columns.`);
                                
                                // กรองเฉพาะคอลัมน์ที่มีอยู่จริง
                                const validColumns = templateSelectedColumns.filter(col => currentHeaders.includes(col));
                                const validColumnTypes = {};
                                
                                // กรองประเภทคอลัมน์เฉพาะที่มีอยู่จริง
                                validColumns.forEach(col => {
                                    if (templateColumnTypes[col]) {
                                        validColumnTypes[col] = templateColumnTypes[col];
                                    }
                                });
                                
                                // อัปเดตเฉพาะคอลัมน์ที่มีอยู่จริง
                                setSheetsData(prevData => ({
                                    ...prevData,
                                    [currentSheetName]: {
                                        ...prevData[currentSheetName],
                                        tableName: templateTableName,
                                        columnTypes: validColumnTypes,
                                        selectedColumns: validColumns
                                    }
                                }));
                            } else {
                                // ทุกคอลัมน์มีอยู่จริง ใช้เทมเพลตได้เลย
                                setSheetsData(prevData => ({
                                    ...prevData,
                                    [currentSheetName]: {
                                        ...prevData[currentSheetName],
                                        tableName: templateTableName,
                                        columnTypes: { ...templateColumnTypes },
                                        selectedColumns: [...templateSelectedColumns]
                                    }
                                }));
                            }
                        }
                    } catch (error) {
                        console.error("Error reading Excel file:", error);
                        alert("Failed to apply template. Please check the file format.");
                    }
                };
                
                reader.onerror = () => {
                    alert("Error reading file");
                };
                
                reader.readAsArrayBuffer(excelFile);
            };

            const deleteTemplate = (templateName) => {
                if (confirm(`Are you sure you want to delete template "${templateName}"?`)) {
                    const updatedTemplates = { ...templates };
                    delete updatedTemplates[templateName];
                    setTemplates(updatedTemplates);
                    alert(`Template "${templateName}" deleted successfully`);
                }
            };
            
            const clearAllTemplates = () => {
                if (confirm("Are you sure you want to delete ALL templates?")) {
                    setTemplates({});
                    localStorage.removeItem('excelToSqlTemplates');
                    alert("All templates have been deleted");
                }
            };
            
            const exportAllSql = () => {
                const exportableSheets = Object.keys(sheetsData).filter(
                    sheetName => sheetsData[sheetName].tableName && sheetsData[sheetName].selectedColumns.length > 0
                );
                
                if (exportableSheets.length === 0) {
                    alert("No configured sheets to export. Please configure at least one sheet first.");
                    return;
                }
                
                // Ask if user wants to save as template
                const saveAsTemplate = confirm("Do you want to save the current configuration as a template?");
                
                if (saveAsTemplate) {
                    const defaultName = `${fileName.split('.')[0]} - Export ${new Date().toISOString().slice(0, 16).replace('T', ' ')}`;
                    const templateName = prompt("Enter a name for this export template:", defaultName);
                    
                    if (templateName) {
                        const templateData = {};
                        
                        exportableSheets.forEach(sheetName => {
                            const sheetData = sheetsData[sheetName];
                            templateData[sheetName] = {
                                tableName: sheetData.tableName,
                                columnTypes: sheetData.columnTypes,
                                selectedColumns: sheetData.selectedColumns,
                                fileName: fileName,
                                headerRow: sheetData.headerRow,
                                timestamp: new Date().toISOString()
                            };
                        });
                        
                        setTemplates({
                            ...templates,
                            [templateName]: templateData
                        });
                    }
                }
                
                // Generate and download each SQL file
                exportableSheets.forEach(sheetName => {
                    downloadSql(sheetName);
                });
                
                alert(`Exported ${exportableSheets.length} SQL file(s)`);
            };
            
            // Render different views based on currentView state
            const renderView = () => {
                switch (currentView) {
                    case 'configureSheet':
                        return <SheetConfiguration 
                            sheetName={selectedSheetName}
                            sheetData={sheetsData[selectedSheetName]}
                            onSave={(tableName, selectedColumns, columnTypes) => {
                                setSheetsData({
                                    ...sheetsData,
                                    [selectedSheetName]: {
                                        ...sheetsData[selectedSheetName],
                                        tableName,
                                        selectedColumns,
                                        columnTypes
                                    }
                                });
                                setCurrentView('main');
                            }}
                            onCancel={() => setCurrentView('main')}
                            onHeaderRowChange={(newHeaderRow) => changeHeaderRow(selectedSheetName, newHeaderRow, false)}
                            templates={templates}
                            onSaveTemplate={(templateName) => saveTemplate(selectedSheetName, templateName)}
                            onLoadTemplate={(templateName, templateSheetName) => loadTemplate(templateName, templateSheetName)}
                        />;
                    case 'manageTemplates':
                        return <TemplateManagement 
                            templates={templates}
                            onDelete={deleteTemplate}
                            onClearAll={clearAllTemplates}
                            onClose={() => setCurrentView('main')}
                        />;
                    default:
                        return <MainView 
                            excelFile={excelFile}
                            fileName={fileName}
                            sheetsData={sheetsData}
                            onImportExcel={importExcel}
                            onConfigureSheet={configureSheet}
                            onDeleteSheet={deleteSheet}
                            onManageTemplates={() => setCurrentView('manageTemplates')}
                            onClearTemplates={clearAllTemplates}
                            onPreviewSql={previewSql}
                            onGenerateExcelFormula={generateExcelFormula}
                            onExportAllSql={exportAllSql}
                            isLoading={isLoading}
                        />;
                }
            };
            
            return (
                <div className="container mx-auto px-4 py-8">
                    <header className="flex items-center justify-between mb-8">
                        <div className="flex items-center">
                            <svg className="w-8 h-8 text-indigo-600 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 7v10c0 2 1 3 3 3h10c2 0 3-1 3-3V7c0-2-1-3-3-3H7c-2 0-3 1-3 3z" />
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 3v4" />
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 3v4" />
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 14l2 2 4-4" />
                            </svg>
                            <h1 className="text-3xl font-bold logo-gradient">Excel to SQL Converter</h1>
                        </div>
                        {currentView !== 'main' && (
                            <button 
                                className="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-md flex items-center"
                                onClick={() => setCurrentView('main')}
                            >
                                <svg className="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                                </svg>
                                Back to Main
                            </button>
                        )}
                    </header>
                    
                    {renderView()}
                    
                    {/* SQL Preview Modal */}
                    <div id="sqlPreviewModal" className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                        <div className="bg-white rounded-lg shadow-lg w-11/12 max-w-4xl max-h-screen flex flex-col">
                            <div className="flex justify-between items-center border-b p-4">
                                <h3 className="text-lg font-medium">SQL Preview</h3>
                                <button 
                                    className="text-gray-400 hover:text-gray-500"
                                    onClick={() => document.getElementById('sqlPreviewModal').classList.add('hidden')}
                                >
                                    <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            <div className="p-4 overflow-auto flex-grow">
                                <pre className="language-sql bg-gray-100 p-4 rounded-md overflow-x-auto text-sm">{sqlPreview}</pre>
                            </div>
                            <div className="border-t p-4 flex justify-end">
                                <button 
                                    className="btn-secondary mr-2"
                                    onClick={() => {
                                        navigator.clipboard.writeText(sqlPreview);
                                        alert("SQL copied to clipboard!");
                                    }}
                                >
                                    Copy to Clipboard
                                </button>
                                <button 
                                    className="btn-secondary"
                                    onClick={() => document.getElementById('sqlPreviewModal').classList.add('hidden')}
                                >
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {/* Excel Formula Modal */}
                    <div id="formulaModal" className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                        <div className="bg-white rounded-lg shadow-lg w-11/12 max-w-2xl">
                            <div className="flex justify-between items-center border-b p-4">
                                <h3 className="text-lg font-medium">Excel Formula</h3>
                                <button 
                                    className="text-gray-400 hover:text-gray-500"
                                    onClick={() => document.getElementById('formulaModal').classList.add('hidden')}
                                >
                                    <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            <div className="p-4">
                                <p className="mb-2">Copy this formula to Excel:</p>
                                <div className="bg-gray-100 p-3 rounded-md overflow-x-auto">
                                    <code id="formulaText" className="text-sm whitespace-pre-wrap break-all"></code>
                                </div>
                            </div>
                            <div className="border-t p-4 flex justify-end">
                                <button 
                                    className="btn-secondary mr-2"
                                    onClick={() => {
                                        const formula = document.getElementById('formulaText').textContent;
                                        navigator.clipboard.writeText(formula);
                                        alert("Formula copied to clipboard!");
                                    }}
                                >
                                    Copy to Clipboard
                                </button>
                                <button 
                                    className="btn-secondary"
                                    onClick={() => document.getElementById('formulaModal').classList.add('hidden')}
                                >
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // Main view component that shows file import and sheet selection
        const MainView = ({ 
            excelFile, 
            fileName, 
            sheetsData, 
            onImportExcel, 
            onConfigureSheet,
            onDeleteSheet,
            onManageTemplates, 
            onClearTemplates,
            onPreviewSql,
            onGenerateExcelFormula,
            onExportAllSql,
            isLoading
        }) => {
            const fileInputRef = React.useRef(null);
            
            return (
                <div>
                    {/* File Selection Section */}
                    <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h2 className="text-xl font-semibold mb-4">Excel File Selection</h2>
                        <div className="flex flex-wrap items-center">
                            <button 
                                className="btn-primary flex items-center"
                                onClick={() => fileInputRef.current.click()}
                            >
                                <svg className="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Import Excel File
                            </button>
                            <input 
                                type="file" 
                                ref={fileInputRef}
                                className="hidden" 
                                accept=".xlsx,.xls" 
                                onChange={onImportExcel}
                            />
                            <span className="ml-4 text-gray-700">
                                {fileName ? (
                                    <span className="flex items-center">
                                        <svg className="w-5 h-5 text-green-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        {fileName}
                                    </span>
                                ) : (
                                    <span className="text-gray-500">No file selected</span>
                                )}
                            </span>
                        </div>
                    </div>
                    
                    {/* Template Management */}
                    <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h2 className="text-xl font-semibold mb-4">Templates</h2>
                        <div className="flex flex-wrap">
                            <button 
                                className="btn-secondary flex items-center mr-3"
                                onClick={onManageTemplates}
                            >
                                <svg className="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                </svg>
                                Manage Templates
                            </button>
                            <button 
                                className="btn-secondary flex items-center"
                                onClick={onClearTemplates}
                            >
                                <svg className="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Clear All Templates
                            </button>
                        </div>
                    </div>
                    
                    {/* Excel Sheets Section */}
                    <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h2 className="text-xl font-semibold mb-4">Excel Sheets</h2>
                        
                        {isLoading ? (
                            <div className="text-center py-16">
                                <svg className="animate-spin h-10 w-10 text-indigo-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <p className="text-gray-600">Loading Excel data...</p>
                            </div>
                        ) : Object.keys(sheetsData).length > 0 ? (
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Sheet Name
                                            </th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Row Count
                                            </th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Header Row
                                            </th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Table Name
                                            </th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Columns
                                            </th>
                                            <th scope="col" className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Actions
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {Object.keys(sheetsData).map(sheetName => (
                                            <tr key={sheetName} className="hover:bg-gray-50">
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                    {sheetName}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    {sheetsData[sheetName].rowCount}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    {sheetsData[sheetName].headerRow}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    {sheetsData[sheetName].tableName || <span className="text-red-500">Not configured</span>}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    {sheetsData[sheetName].selectedColumns.length > 0 ? 
                                                        `${sheetsData[sheetName].selectedColumns.length} selected` : 
                                                        <span className="text-red-500">None selected</span>
                                                    }
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                                    <div className="flex justify-center space-x-2">
                                                        <button 
                                                            className="p-1 bg-indigo-100 text-indigo-600 rounded hover:bg-indigo-200 tooltip"
                                                            onClick={() => onConfigureSheet(sheetName)}
                                                            title="Configure Sheet"
                                                        >
                                                            <svg className="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                            </svg>
                                                        </button>
                                                        
                                                        <button 
                                                            className="p-1 bg-red-100 text-red-600 rounded hover:bg-red-200 tooltip"
                                                            onClick={() => onDeleteSheet(sheetName)}
                                                            title="Delete Sheet"
                                                        >
                                                            <svg className="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                            </svg>
                                                        </button>
                                                        
                                                        {sheetsData[sheetName].tableName && sheetsData[sheetName].selectedColumns.length > 0 && (
                                                            <>
                                                                <button 
                                                                    className="p-1 bg-blue-100 text-blue-600 rounded hover:bg-blue-200 tooltip"
                                                                    onClick={() => onPreviewSql(sheetName)}
                                                                    title="Preview SQL"
                                                                >
                                                                    <svg className="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                                                    </svg>
                                                                </button>
                                                                <button 
                                                                    className="p-1 bg-green-100 text-green-600 rounded hover:bg-green-200 tooltip"
                                                                    onClick={() => onGenerateExcelFormula(sheetName)}
                                                                    title="Generate Excel Formula"
                                                                >
                                                                    <svg className="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                                                    </svg>
                                                                </button>
                                                            </>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        ) : (
                            <div className="text-center py-16">
                                <svg className="w-16 h-16 text-gray-300 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <p className="text-gray-500 mb-4">No Excel file loaded</p>
                                <button 
                                    className="btn-primary"
                                    onClick={() => fileInputRef.current.click()}
                                >
                                    Import Excel File
                                </button>
                            </div>
                        )}
                    </div>
                    
                    {/* Actions Section */}
                    {Object.keys(sheetsData).length > 0 && (
                        <div className="flex justify-end mb-6">
                            <button 
                                className="btn-primary flex items-center"
                                onClick={onExportAllSql}
                            >
                                <svg className="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Export SQL Files
                            </button>
                        </div>
                    )}
                </div>
            );
        };
        
        // Sheet configuration component
        const SheetConfiguration = ({ 
            sheetName, 
            sheetData, 
            onSave, 
            onCancel, 
            onHeaderRowChange,
            templates,
            onSaveTemplate,
            onLoadTemplate
        }) => {
            const [tableName, setTableName] = React.useState(sheetData.tableName || '');
            const [headerRow, setHeaderRow] = React.useState(sheetData.headerRow || 1);
            const [availableColumns, setAvailableColumns] = React.useState([]);
            const [selectedColumns, setSelectedColumns] = React.useState([]);
            const [columnTypes, setColumnTypes] = React.useState({});
            const [dragItem, setDragItem] = React.useState(null);
            const [showTemplates, setShowTemplates] = React.useState(false);
            
            // Update local state when sheetData changes (e.g., when a template is loaded)
            React.useEffect(() => {
                setTableName(sheetData.tableName || '');
                setHeaderRow(sheetData.headerRow || 1);
                
                // Copy header data from sheetData
                const headers = [...sheetData.headers];
                
                // Initialize selected columns from saved data
                const savedSelected = sheetData.selectedColumns || [];
                const savedTypes = sheetData.columnTypes || {};
                
                // Filter available columns to those not selected and that have data
                const availableCols = headers.filter(col => !savedSelected.includes(col));
                
                setAvailableColumns(availableCols);
                setSelectedColumns(savedSelected);
                setColumnTypes(savedTypes);
            }, [sheetData]);
            
            React.useEffect(() => {
                if (sheetData.data && sheetData.data.length > 0) {
                    // ตรวจสอบว่าแต่ละคอลัมน์มีข้อมูลหรือไม่
                    const columnsWithData = sheetData.headers
                        .map((header, colIdx) => ({
                            name: header,                            // ชื่อจริง เช่น Name, Age
                            colIdx: colIdx,
                            colName: sheetData.columnNames[colIdx]    // ชื่อคอลัมน์จริง เช่น A, B, C
                        }))
                        .filter(col => 
                            sheetData.data.some(row => {
                                const cellValue = row[col.colIdx];
                                return cellValue !== undefined && cellValue !== null && String(cellValue).trim() !== '';
                            })
                        );

                    // กรองคอลัมน์ที่ถูกเลือกออกไป
                    const availableCols = columnsWithData.filter(col => 
                        !sheetData.selectedColumns.includes(col.name)
                    );

                    setAvailableColumns(availableCols);
                } else {
                    // ถ้าไม่มีข้อมูล ให้เคลียร์ availableColumns
                    setAvailableColumns([]);
                }
            }, [sheetData]);



            const handleHeaderRowChange = () => {
                if (headerRow < 1) {
                    alert("Header row must be at least 1");
                    return;
                }
                
                onHeaderRowChange(headerRow);
            };
            
            const moveToSelected = (columnName) => {
                setAvailableColumns(prevAvailable => 
                    prevAvailable.filter(col => col.name !== columnName)
                );
                
                setSelectedColumns(prevSelected => 
                    [...prevSelected, columnName]
                );
                
                // Initialize new column with default type of "text"
                setColumnTypes(prevTypes => ({
                    ...prevTypes,
                    [columnName]: prevTypes[columnName] || "text" // Default to text
                }));
            };


            // ฟังก์ชันแปลง Index เป็นชื่อคอลัมน์ เช่น 0 → A, 1 → B, 26 → AA
            const getColumnName = (index) => {
                let columnName = '';
                while (index >= 0) {
                    columnName = String.fromCharCode((index % 26) + 65) + columnName;
                    index = Math.floor(index / 26) - 1;
                }
                return columnName;
            };
            
            const moveToAvailable = (columnName) => {
                // หา colIdx จาก headers เพื่อใช้ map กลับไปเป็น colName
                const colIdx = sheetData.headers.indexOf(columnName);
                const colName = sheetData.columnNames[colIdx];

                setSelectedColumns(prevSelected => 
                    prevSelected.filter(col => col !== columnName)
                );

                setAvailableColumns(prevAvailable => 
                    [...prevAvailable, { name: columnName, colIdx: colIdx, colName: colName }]
                );
            };

            // แก้ไขฟังก์ชัน moveAllToSelected เพื่อตั้งค่า columnTypes สำหรับทุกคอลัมน์
            const moveAllToSelected = () => {
                // ดึงเฉพาะชื่อ (name) ของทุกคอลัมน์ใน availableColumns
                const allAvailable = availableColumns.map(col => col.name);

                // อัปเดต selectedColumns ก่อน
                setSelectedColumns(prevSelected => [...prevSelected, ...allAvailable]);

                // ตั้งค่า columnTypes สำหรับคอลัมน์ทั้งหมดที่เพิ่มเข้ามา
                setColumnTypes(prevTypes => {
                    const newTypes = { ...prevTypes };
                    
                    // ตั้งค่า default type เป็น "text" สำหรับทุกคอลัมน์ใหม่
                    allAvailable.forEach(colName => {
                        // ตั้งค่าเฉพาะคอลัมน์ที่ยังไม่มี type กำหนดไว้
                        if (!newTypes[colName]) {
                            newTypes[colName] = "text";
                        }
                    });
                    
                    return newTypes;
                });

                // แล้วค่อยเคลียร์ availableColumns
                setAvailableColumns([]);
            };

            const moveAllToAvailable = () => {
                // นำทุกคอลัมน์จาก selectedColumns กลับไปที่ availableColumns พร้อมรักษาโครงสร้าง
                const allSelected = selectedColumns.map(columnName => {
                    const colIdx = sheetData.headers.indexOf(columnName);
                    const colName = sheetData.columnNames[colIdx];
                    return { name: columnName, colIdx: colIdx, colName: colName };
                });

                // อัปเดต availableColumns ก่อน แล้วค่อยเคลียร์ selectedColumns
                setAvailableColumns(prevAvailable => [...prevAvailable, ...allSelected]);
                setSelectedColumns([]);
            };

            const changeColumnType = (column, type) => {
                setColumnTypes({
                    ...columnTypes,
                    [column]: type
                });
            };
            
            const handleDragStart = (e, column, from) => {
                setDragItem({ column, from });
            };
            
            const handleDragOver = (e) => {
                e.preventDefault();
            };
            
            const handleDrop = (e, targetArea) => {
                e.preventDefault();
                
                if (!dragItem) return;
                
                const { column, from } = dragItem;
                
                if (from === 'available' && targetArea === 'selected') {
                    moveToSelected(column);
                } else if (from === 'selected' && targetArea === 'available') {
                    moveToAvailable(column);
                }
                
                setDragItem(null);
            };
            
            const moveUp = (index) => {
                if (index === 0) return; // ถ้าอยู่บนสุดแล้ว หยุดการทำงาน

                setSelectedColumns(prevSelected => {
                    const newColumns = [...prevSelected];
                    // Swap ตำแหน่งปัจจุบันกับตำแหน่งก่อนหน้า
                    [newColumns[index], newColumns[index - 1]] = [newColumns[index - 1], newColumns[index]];
                    return newColumns;
                });
            };

            const moveDown = (index) => {
                if (index === selectedColumns.length - 1) return; // ถ้าอยู่ล่างสุดแล้ว หยุดการทำงาน

                setSelectedColumns(prevSelected => {
                    const newColumns = [...prevSelected];
                    // Swap ตำแหน่งปัจจุบันกับตำแหน่งถัดไป
                    [newColumns[index], newColumns[index + 1]] = [newColumns[index + 1], newColumns[index]];
                    return newColumns;
                });
            };

            const handleSaveClick = () => {
                // Validate table name
                if (!tableName.trim()) {
                    alert("Please enter a table name");
                    return;
                }
                
                // Validate columns
                if (selectedColumns.length === 0) {
                    alert("Please select at least one column");
                    return;
                }
                
                onSave(tableName, selectedColumns, columnTypes);
            };

            // เพิ่มฟังก์ชัน getSortedTemplates ลงในคอมโพเนนต์ SheetConfiguration
            const getSortedTemplates = () => {
                return Object.keys(templates).map(templateName => {
                    const template = templates[templateName];
                    
                    // หา timestamp ล่าสุดจากทุก sheet ในเทมเพลต
                    const timestamps = Object.values(template).map(t => t.timestamp || new Date(0));
                    const latestTimestamp = new Date(Math.max(...timestamps.map(t => new Date(t))));
                    
                    return {
                        name: templateName,
                        template: template,
                        timestamp: latestTimestamp
                    };
                }).sort((a, b) => b.timestamp - a.timestamp); // เรียงจากใหม่ไปเก่า
            };

            
            return (
                <div>
                    <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h2 className="text-xl font-semibold mb-4">Configure Sheet: {sheetName}</h2>
                        
                        {/* Table name and header row */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Table Name</label>
                                <input 
                                    type="text"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                    value={tableName}
                                    onChange={(e) => setTableName(e.target.value)}
                                    placeholder="Enter SQL table name"
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Header Row</label>
                                <div className="flex items-center">
                                    <input 
                                        type="number"
                                        min="1"
                                        className="w-24 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                        value={headerRow}
                                        onChange={(e) => setHeaderRow(parseInt(e.target.value) || 1)}
                                    />
                                    <button 
                                        className="ml-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-md"
                                        onClick={handleHeaderRowChange}
                                    >
                                        Apply
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Templates</label>
                                <div className="flex">
                                    <button 
                                        className="px-3 py-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-md mr-2"
                                        onClick={() => setShowTemplates(true)}
                                    >
                                        Load Template
                                    </button>
                                    <button 
                                        className="px-3 py-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-md"
                                        onClick={() => {
                                            const name = prompt("Enter template name:", `${sheetName} - ${new Date().toLocaleDateString()}`);
                                            if (name) onSaveTemplate(name);
                                        }}
                                    >
                                        Save Template
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        {/* Column selection area */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            {/* Available columns */}
                            <div 
                                className="border border-gray-300 rounded-md p-4"
                                onDragOver={handleDragOver}
                                onDrop={(e) => handleDrop(e, 'available')}
                            >
                                <h3 className="text-lg font-medium mb-2 text-gray-700">Available Columns</h3>
                                <p className="text-sm text-gray-500 mb-2">Drag columns to the right or double-click to add them</p>
                                
                                <div className="h-64 overflow-y-auto border border-gray-200 rounded-md">
                                    <ul className="divide-y divide-gray-200">
                                        {availableColumns.map((column) => (
                                            <li 
                                                key={`avail-${column.name}`}
                                                className="px-3 py-2 hover:bg-gray-50 cursor-pointer flex items-center justify-between"
                                                onDoubleClick={() => moveToSelected(column.name)}
                                                draggable
                                                onDragStart={(e) => handleDragStart(e, column.name, 'available')}
                                            >
                                                <span className="text-sm">{column.colName}: {column.name}</span>
                                                <button 
                                                    className="text-indigo-600 hover:text-indigo-800"
                                                    onClick={() => moveToSelected(column.name)}
                                                >
                                                    <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" />
                                                    </svg>
                                                </button>
                                            </li>
                                        ))}

                                        {availableColumns.length === 0 && (
                                            <li className="px-3 py-4 text-center text-gray-500 italic">
                                                All columns have been selected
                                            </li>
                                        )}
                                    </ul>
                                </div>
                                
                                <div className="mt-2 flex justify-end">
                                    <button 
                                        className="px-3 py-1 text-sm bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200"
                                        onClick={moveAllToSelected}
                                        disabled={availableColumns.length === 0}
                                    >
                                        Select All →
                                    </button>

                                </div>
                            </div>
                            
                            {/* Selected columns */}
                            <div 
                                className="border border-gray-300 rounded-md p-4"
                                onDragOver={handleDragOver}
                                onDrop={(e) => handleDrop(e, 'selected')}
                            >
                                <h3 className="text-lg font-medium mb-2 text-gray-700">Selected Columns</h3>
                                <p className="text-sm text-gray-500 mb-2">Reorder columns with arrows, right-click to change data type</p>
                                
                                <div className="h-64 overflow-y-auto border border-gray-200 rounded-md">
                                    <ul className="divide-y divide-gray-200">
                                        {selectedColumns.map((column, index) => {
                                            const colIdx = sheetData.headers.indexOf(column);
                                            return (
                                                <li 
                                                    key={`sel-${column}`}
                                                    className="px-3 py-2 hover:bg-gray-50 cursor-pointer"
                                                    draggable
                                                    onDragStart={(e) => handleDragStart(e, column, 'selected')}
                                                >
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex items-center">
                                                            <span className="text-sm">{sheetData.columnNames[colIdx]}: {column}</span>
                                                            <div className="ml-2 inline-block">
                                                                <select 
                                                                    className="text-xs border border-gray-300 rounded px-1 py-0.5"
                                                                    value={columnTypes[column] || 'text'}
                                                                    onChange={(e) => changeColumnType(column, e.target.value)}
                                                                >
                                                                    <option value="text">TEXT</option>
                                                                    <option value="int">INT</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div className="flex space-x-1">
                                                            <button 
                                                                className="text-gray-400 hover:text-gray-600"
                                                                onClick={() => moveUp(index)}
                                                                disabled={index === 0} // ปิดปุ่มถ้าอยู่บนสุด
                                                            >
                                                                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                                                                </svg>
                                                            </button>
                                                            <button 
                                                                className="text-gray-400 hover:text-gray-600"
                                                                onClick={() => moveDown(index)}
                                                                disabled={index === selectedColumns.length - 1} // ปิดปุ่มถ้าอยู่ล่างสุด
                                                            >
                                                                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                                                </svg>
                                                            </button>
                                                            <button 
                                                                className="text-red-400 hover:text-red-600"
                                                                onClick={() => moveToAvailable(column)}
                                                            >
                                                                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 17l-5-5m0 0l5-5m-5 5h12" />
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </li>
                                            );
                                        })}

                                        {selectedColumns.length === 0 && (
                                            <li className="px-3 py-4 text-center text-gray-500 italic">
                                                No columns selected
                                            </li>
                                        )}
                                    </ul>
                                </div>
                                
                                <div className="mt-2 flex justify-between">
                                    <div>
                                        <label className="text-sm text-gray-500 mr-2">Header Row:</label>
                                        <input 
                                            type="number"
                                            min="1"
                                            className="w-16 px-2 py-1 text-sm border border-gray-300 rounded"
                                            value={headerRow}
                                            onChange={(e) => setHeaderRow(parseInt(e.target.value) || 1)}
                                        />
                                        <button 
                                            className="ml-1 px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200"
                                            onClick={handleHeaderRowChange}
                                        >
                                            Update
                                        </button>
                                    </div>
                                    <button 
                                        className="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200"
                                        onClick={moveAllToAvailable}
                                        disabled={selectedColumns.length === 0}
                                    >
                                        ← Remove All
                                    </button>

                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Preview of data */}
                    <div className="bg-white rounded-lg shadow-md p-6 mb-6 overflow-x-auto">
                        <h3 className="text-lg font-medium mb-4 text-gray-700">Data Preview</h3>
                        
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    {sheetData.headers.map((header, idx) => (
                                        <th 
                                            key={idx}
                                            scope="col" 
                                            className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                        >
                                            {header}
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {sheetData.data.slice(0, 5).map((row, rowIdx) => (
                                    <tr key={rowIdx} className={rowIdx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                        {sheetData.headers.map((header, colIdx) => (
                                            <td 
                                                key={colIdx}
                                                className={`px-6 py-4 whitespace-nowrap text-sm text-gray-500 ${
                                                    selectedColumns.includes(header) ? 'bg-indigo-50 font-medium' : ''
                                                }`}
                                            >
                                                {row[colIdx] !== undefined ? String(row[colIdx]) : ''}
                                            </td>
                                        ))}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {sheetData.data.length > 5 && (
                            <div className="text-center text-gray-500 mt-2 text-sm">
                                Showing 5 of {sheetData.data.length} rows
                            </div>
                        )}
                    </div>
                    
                    {/* Action buttons */}
                    <div className="flex justify-end space-x-4 mb-6">
                        <button className="btn-secondary" onClick={onCancel}>
                            Cancel
                        </button>
                        <button className="btn-primary" onClick={handleSaveClick}>
                            Save Configuration
                        </button>
                    </div>
                    
                    {/* Template selection modal */}
                    {showTemplates && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg shadow-lg w-11/12 max-w-4xl max-h-screen flex flex-col">
                                <div className="flex justify-between items-center border-b p-4">
                                    <h3 className="text-lg font-medium">Select Template</h3>
                                    <button 
                                        className="text-gray-400 hover:text-gray-500"
                                        onClick={() => setShowTemplates(false)}
                                    >
                                        <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                <div className="p-4 overflow-auto flex-grow">
                                    {Object.keys(templates).length === 0 ? (
                                        <div className="text-center py-8">
                                            <p className="text-gray-500">No templates available</p>
                                        </div>
                                    ) : (
                                        <div className="overflow-x-auto">
                                            <table className="min-w-full divide-y divide-gray-200">
                                                <thead className="bg-gray-50">
                                                    <tr>
                                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                            Template Name
                                                        </th>
                                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                            Template Sheet
                                                        </th>
                                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                            Table Name
                                                        </th>
                                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                            Columns
                                                        </th>
                                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                            Header Row
                                                        </th>
                                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                            Date Created
                                                        </th>
                                                        <th scope="col" className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                            Actions
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody className="bg-white divide-y divide-gray-200">
                                                    {getSortedTemplates().map(item => {
                                                        const templateName = item.name;
                                                        const timestamp = item.timestamp;
                                                        
                                                        return Object.keys(templates[templateName]).map(templateSheetName => {
                                                            const template = templates[templateName][templateSheetName];
                                                            const date = template.timestamp ? new Date(template.timestamp) : timestamp;
                                                            
                                                            return (
                                                                <tr key={`${templateName}-${templateSheetName}`} className="hover:bg-gray-50">
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                                        {templateName}
                                                                    </td>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                                        {templateSheetName}
                                                                    </td>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                                        {template.tableName}
                                                                    </td>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                                        {template.selectedColumns.slice(0, 3).join(", ")}
                                                                        {template.selectedColumns.length > 3 ? "..." : ""}
                                                                    </td>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                                        {template.headerRow || 1}
                                                                    </td>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                                        {date.toLocaleString()}
                                                                    </td>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                                                        <button 
                                                                            className="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700"
                                                                            onClick={() => {
                                                                                // ส่งชื่อเทมเพลตและชื่อชีตในเทมเพลต แต่จะใช้กับชีตปัจจุบัน
                                                                                onLoadTemplate(templateName, templateSheetName);
                                                                                setShowTemplates(false);
                                                                            }}
                                                                        >
                                                                            Apply
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                            );
                                                        });
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>
                                <div className="border-t p-4 flex justify-end">
                                    <button 
                                        className="btn-secondary"
                                        onClick={() => setShowTemplates(false)}
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // แก้ไขฟังก์ชัน TemplateManagement component เพื่อเรียงลำดับเทมเพลตจากใหม่ไปเก่า
        const TemplateManagement = ({ templates, onDelete, onClearAll, onClose }) => {
            // เรียงลำดับเทมเพลตจากใหม่ไปเก่าโดยใช้ timestamp
            const getSortedTemplates = () => {
                return Object.keys(templates).map(templateName => {
                    const template = templates[templateName];
                    
                    // หา timestamp ล่าสุดจากทุก sheet ในเทมเพลต
                    const timestamps = Object.values(template).map(t => t.timestamp);
                    const latestTimestamp = new Date(Math.max(...timestamps.map(t => new Date(t))));
                    
                    return {
                        name: templateName,
                        template: template,
                        timestamp: latestTimestamp
                    };
                }).sort((a, b) => b.timestamp - a.timestamp); // เรียงจากใหม่ไปเก่า
            };
            
            const sortedTemplates = getSortedTemplates();
            
            return (
                <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 className="text-xl font-semibold mb-4">Template Management</h2>
                    
                    {Object.keys(templates).length === 0 ? (
                        <div className="text-center py-16">
                            <svg className="w-16 h-16 text-gray-300 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 13h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p className="text-gray-500 mb-4">No templates available</p>
                        </div>
                    ) : (
                        <>
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Template Name
                                            </th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                File Name
                                            </th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Sheets
                                            </th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Date Created
                                            </th>
                                            <th scope="col" className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Actions
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {sortedTemplates.map(item => {
                                            const templateName = item.name;
                                            const template = item.template;
                                            const timestamp = item.timestamp;
                                            const sheetCount = Object.keys(template).length;
                                            const fileName = Object.values(template)[0]?.fileName || 'Unknown';
                                            
                                            return (
                                                <tr key={templateName} className="hover:bg-gray-50">
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                        {templateName}
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                        {fileName}
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                        {sheetCount}
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                        {timestamp.toLocaleString()}
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                                        <button 
                                                            className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700"
                                                            onClick={() => onDelete(templateName)}
                                                        >
                                                            Delete
                                                        </button>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div className="mt-6 flex justify-end">
                                <button 
                                    className="btn-danger mr-4"
                                    onClick={onClearAll}
                                >
                                    Clear All Templates
                                </button>
                                <button 
                                    className="btn-secondary"
                                    onClick={onClose}
                                >
                                    Close
                                </button>
                            </div>
                        </>
                    )}
                </div>
            );
        };
        
        // Render the application
        ReactDOM.render(<App />, document.getElementById('app'));
    </script>
</body>
</html>